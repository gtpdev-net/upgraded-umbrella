@page "/servers/{SourceId:int}/databases"
@rendermode InteractiveServer
@inject ICatalogueRepository Repository
@inject NotificationService Notify

<PageTitle>Databases &mdash; Source Catalogue</PageTitle>

<BreadcrumbNav Items="@_breadcrumbs" />

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Databases â€” @_serverName</h1>
    <a href="/servers/@SourceId/databases/new" class="btn btn-primary">Add Database</a>
</div>

@if (_databases is null)
{
    <div class="spinner-border" role="status"></div>
}
else
{
    <PaginatedTable TItem="SourceDatabaseInfo" Items="_databases" PageSize="25">
        <HeaderTemplate>
            <th>Database Name</th>
            <th>Description</th>
            <th># Tables</th>
            <th># In-Scope</th>
            <th># For Load</th>
            <th>Active</th>
            <th></th>
        </HeaderTemplate>
        <RowTemplate Context="db">
            <td><a href="/servers/@SourceId/databases/@db.DatabaseId/tables">@db.DatabaseName</a></td>
            <td>@db.Description</td>
            <td>@db.TableCount</td>
            <td>@db.InScopeColumnCount</td>
            <td>@db.SelectedForLoadCount</td>
            <td><FlagBadge Value="@db.IsActive" /></td>
            <td>
                <a href="/servers/@SourceId/databases/@db.DatabaseId/edit"
                   class="btn btn-sm btn-outline-secondary">Edit</a>
            </td>
        </RowTemplate>
    </PaginatedTable>
}

@code {
    [Parameter] public int SourceId { get; set; }

    private List<SourceDatabaseInfo>? _databases;
    private string _serverName = string.Empty;
    private IEnumerable<BreadcrumbItem> _breadcrumbs = [];

    protected override async Task OnParametersSetAsync()
    {
        var source = await Repository.GetSourceByIdAsync(SourceId);
        _serverName = source?.ServerName ?? SourceId.ToString();

        _breadcrumbs =
        [
            new BreadcrumbItem("Servers", "/servers"),
            new BreadcrumbItem(_serverName, isActive: true)
        ];

        var dbs = await Repository.GetInScopeDatabasesAsync(sourceId: SourceId, includeInactive: true);
        _databases = dbs.ToList();
    }
}
