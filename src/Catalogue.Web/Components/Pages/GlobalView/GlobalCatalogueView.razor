@page "/catalogue"
@rendermode InteractiveServer
@inject ICatalogueRepository Repository
@inject NavigationManager Nav
@inject NotificationService Notify

<PageTitle>Global Catalogue &mdash; Source Catalogue</PageTitle>

<h1 class="mb-3">Global Catalogue</h1>

<!-- Filter bar -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-2">
            <div class="col-md-3">
                <input class="form-control form-control-sm" placeholder="Server..." @bind="_filterServer" @bind:event="oninput" />
            </div>
            <div class="col-md-3">
                <input class="form-control form-control-sm" placeholder="Database..." @bind="_filterDatabase" @bind:event="oninput" />
            </div>
            <div class="col-md-3">
                <input class="form-control form-control-sm" placeholder="Schema..." @bind="_filterSchema" @bind:event="oninput" />
            </div>
            <div class="col-md-3">
                <input class="form-control form-control-sm" placeholder="Table..." @bind="_filterTable" @bind:event="oninput" />
            </div>
            <div class="col-md-3">
                <input class="form-control form-control-sm" placeholder="Column..." @bind="_filterColumn" @bind:event="oninput" />
            </div>
            <div class="col-md-3">
                <select class="form-select form-select-sm" @bind="_filterPersistence">
                    <option value="">Any Type</option>
                    <option value="R">Relational (R)</option>
                    <option value="D">Document (D)</option>
                    <option value="B">Both (B)</option>
                </select>
            </div>
        </div>

        <!-- Preset chips -->
        <div class="mt-2 d-flex gap-2 flex-wrap">
            @foreach (var preset in _presets)
            {
                <span class="badge @(ActivePreset == preset.Key ? "text-bg-primary" : "text-bg-light border") fs-6"
                      style="cursor:pointer" @onclick="() => ApplyPreset(preset.Key)">
                    @preset.Label
                </span>
            }
            @if (!string.IsNullOrEmpty(ActivePreset))
            {
                <span class="badge text-bg-secondary fs-6" style="cursor:pointer" @onclick="ClearPresets">Clear</span>
            }
        </div>
    </div>
</div>

<!-- Bulk action toolbar -->
@if (_selected.Count > 0)
{
    <div class="alert alert-primary d-flex align-items-center gap-3 mb-3">
        <strong>@_selected.Count selected</strong>
        <button class="btn btn-sm btn-outline-primary" @onclick='() => BulkSet("isInDaoAnalysis", true)'>Set DAO ✓</button>
        <button class="btn btn-sm btn-outline-primary" @onclick='() => BulkSet("isAddedByApi", true)'>Set API ✓</button>
        <button class="btn btn-sm btn-outline-success" @onclick='() => BulkSet("isSelectedForLoad", true)'>Set For Load ✓</button>
        <button class="btn btn-sm btn-outline-warning" @onclick="SetTypeD">Set Type D</button>
        <button class="btn btn-sm btn-outline-info" @onclick="SetTypeB">Set Type B</button>
        <button class="btn btn-sm btn-outline-secondary" @onclick="() => _selected.Clear()">Deselect All</button>
    </div>
}

<div class="d-flex justify-content-between align-items-center mb-2">
    <span class="text-muted small">@Filtered.Count rows</span>
    <button class="btn btn-sm btn-outline-secondary" @onclick="ExportCsv">&#128190; Export CSV</button>
</div>

@if (_all is null)
{
    <div class="spinner-border" role="status"></div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover table-sm align-middle">
            <thead class="table-light">
                <tr>
                    <th><input type="checkbox" @onchange="ToggleAll" /></th>
                    <th @onclick='() => Sort("server")' style="cursor:pointer">Server</th>
                    <th @onclick='() => Sort("database")' style="cursor:pointer">Database</th>
                    <th @onclick='() => Sort("schema")' style="cursor:pointer">Schema</th>
                    <th @onclick='() => Sort("table")' style="cursor:pointer">Table</th>
                    <th @onclick='() => Sort("column")' style="cursor:pointer">Column</th>
                    <th>Type</th>
                    <th>DAO</th>
                    <th>API</th>
                    <th>For Load</th>
                    <th>Modified</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var col in Paged)
                {
                    <tr>
                        <td><input type="checkbox" checked="@_selected.Contains(col.ColumnId)"
                                   @onchange="() => ToggleSelect(col.ColumnId)" /></td>
                        <td class="small">@col.ServerName</td>
                        <td class="small">@col.DatabaseName</td>
                        <td class="small">@col.SchemaName</td>
                        <td class="small">@col.TableName</td>
                        <td class="small">@col.ColumnName</td>
                        <td>
                            <select class="form-select form-select-sm" style="width:60px"
                                    value="@col.PersistenceType.ToString()"
                                    @onchange="async e => await UpdateType(col, string.IsNullOrEmpty(e.Value?.ToString()) ? 'R' : e.Value!.ToString()![0])">
                                <option value="R">R</option>
                                <option value="D">D</option>
                                <option value="B">B</option>
                            </select>
                        </td>
                        <td><input type="checkbox" checked="@col.IsInDaoAnalysis"
                                   @onchange="async () => await ToggleFlag(col, c => c.IsInDaoAnalysis = !c.IsInDaoAnalysis)" /></td>
                        <td><input type="checkbox" checked="@col.IsAddedByApi"
                                   @onchange="async () => await ToggleFlag(col, c => c.IsAddedByApi = !c.IsAddedByApi)" /></td>
                        <td><input type="checkbox" checked="@col.IsSelectedForLoad"
                                   @onchange="async () => await ToggleFlag(col, c => c.IsSelectedForLoad = !c.IsSelectedForLoad)" /></td>
                        <td class="small text-muted">@col.ModifiedAt?.ToString("dd MMM yy")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    @if (TotalPages > 1)
    {
        <nav>
            <ul class="pagination pagination-sm justify-content-end">
                <li class="page-item @(_page == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => _page--">&laquo;</button>
                </li>
                @for (int p = Math.Max(1, _page - 3); p <= Math.Min(TotalPages, _page + 3); p++)
                {
                    var lp = p;
                    <li class="page-item @(_page == lp ? "active" : "")">
                        <button class="page-link" @onclick="() => _page = lp">@lp</button>
                    </li>
                }
                <li class="page-item @(_page == TotalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => _page++">&raquo;</button>
                </li>
            </ul>
        </nav>
    }
}

<ConfirmDialog @ref="_confirmDialog" Title="Bulk Update" ConfirmText="Apply" />

@code {
    private List<SourceColumnInfo>? _all;
    private string _filterServer = "", _filterDatabase = "", _filterSchema = "", _filterTable = "", _filterColumn = "", _filterPersistence = "";
    private string _sortBy = "server";
    private bool _sortAsc = true;
    private int _page = 1;
    private const int PageSize = 50;
    private HashSet<int> _selected = new();
    private string ActivePreset = string.Empty;
    private ConfirmDialog _confirmDialog = null!;

    private record PresetDef(string Key, string Label);
    private static readonly PresetDef[] _presets =
    [
        new("unreviewed", "Unreviewed"),
        new("inScope", "In Scope"),
        new("forLoad", "Selected for Load"),
        new("docCols", "Document Columns"),
        new("daoOnly", "DAO Only"),
        new("apiAdded", "API Added")
    ];

    protected override async Task OnInitializedAsync()
    {
        var cols = await Repository.GetColumnsAsync(filter: ColumnFilter.All);
        _all = cols.ToList();
    }

    private List<SourceColumnInfo> Filtered
    {
        get
        {
            if (_all is null) return [];
            var q = _all.AsEnumerable();
            if (!string.IsNullOrEmpty(_filterServer))   q = q.Where(c => c.ServerName.Contains(_filterServer, StringComparison.OrdinalIgnoreCase));
            if (!string.IsNullOrEmpty(_filterDatabase)) q = q.Where(c => c.DatabaseName.Contains(_filterDatabase, StringComparison.OrdinalIgnoreCase));
            if (!string.IsNullOrEmpty(_filterSchema))   q = q.Where(c => c.SchemaName.Contains(_filterSchema, StringComparison.OrdinalIgnoreCase));
            if (!string.IsNullOrEmpty(_filterTable))    q = q.Where(c => c.TableName.Contains(_filterTable, StringComparison.OrdinalIgnoreCase));
            if (!string.IsNullOrEmpty(_filterColumn))   q = q.Where(c => c.ColumnName.Contains(_filterColumn, StringComparison.OrdinalIgnoreCase));
            if (!string.IsNullOrEmpty(_filterPersistence)) q = q.Where(c => c.PersistenceType.ToString() == _filterPersistence);
            return ApplySort(q.ToList());
        }
    }

    private List<SourceColumnInfo> Paged => Filtered.Skip((_page - 1) * PageSize).Take(PageSize).ToList();
    private int TotalPages => (int)Math.Ceiling(Filtered.Count / (double)PageSize);

    private List<SourceColumnInfo> ApplySort(List<SourceColumnInfo> src)
    {
        return (_sortBy, _sortAsc) switch
        {
            ("server",   true)  => src.OrderBy(c => c.ServerName).ThenBy(c => c.ColumnName).ToList(),
            ("server",   false) => src.OrderByDescending(c => c.ServerName).ThenBy(c => c.ColumnName).ToList(),
            ("database", true)  => src.OrderBy(c => c.DatabaseName).ToList(),
            ("database", false) => src.OrderByDescending(c => c.DatabaseName).ToList(),
            ("schema",   true)  => src.OrderBy(c => c.SchemaName).ToList(),
            ("schema",   false) => src.OrderByDescending(c => c.SchemaName).ToList(),
            ("table",    true)  => src.OrderBy(c => c.TableName).ToList(),
            ("table",    false) => src.OrderByDescending(c => c.TableName).ToList(),
            ("column",   true)  => src.OrderBy(c => c.ColumnName).ToList(),
            ("column",   false) => src.OrderByDescending(c => c.ColumnName).ToList(),
            _ => src
        };
    }

    private void Sort(string col)
    {
        if (_sortBy == col) _sortAsc = !_sortAsc;
        else { _sortBy = col; _sortAsc = true; }
        _page = 1;
    }

    private void ToggleSelect(int id)
    {
        if (!_selected.Add(id)) _selected.Remove(id);
    }

    private void ToggleAll()
    {
        if (_selected.Count > 0) _selected.Clear();
        else _selected = Paged.Select(c => c.ColumnId).ToHashSet();
    }

    private void ApplyPreset(string key)
    {
        ActivePreset = ActivePreset == key ? "" : key;
        _filterServer = _filterDatabase = _filterSchema = _filterTable = _filterColumn = _filterPersistence = "";
        _page = 1;
    }

    private void ClearPresets() { ActivePreset = ""; _page = 1; }

    private async Task ToggleFlag(SourceColumnInfo info, Action<SourceColumn> toggle)
    {
        await Repository.BulkUpdateColumnsAsync(new[] { info.ColumnId }, toggle);
        var refreshed = await Repository.GetColumnsAsync(tableId: info.TableId);
        var updated = refreshed.FirstOrDefault(c => c.ColumnId == info.ColumnId);
        if (updated is not null)
        {
            var idx = _all!.FindIndex(c => c.ColumnId == info.ColumnId);
            if (idx >= 0) _all[idx] = updated;
        }
    }

    private async Task UpdateType(SourceColumnInfo info, char type)
    {
        await Repository.BulkUpdateColumnsAsync(new[] { info.ColumnId }, c => c.PersistenceType = type);
        info.PersistenceType = type;
    }

    private async Task BulkSet(string field, object value)
    {
        if (_selected.Count == 0) return;
        var ok = await _confirmDialog.ShowAsync($"Apply to {_selected.Count} selected columns?");
        if (!ok) return;

        await Repository.BulkUpdateColumnsAsync(_selected, c =>
        {
            switch (field)
            {
                case "isInDaoAnalysis":   c.IsInDaoAnalysis   = (bool)value; break;
                case "isAddedByApi":      c.IsAddedByApi      = (bool)value; break;
                case "isSelectedForLoad": c.IsSelectedForLoad = (bool)value; break;
                case "persistenceType":   c.PersistenceType   = (char)value; break;
            }
        });

        Notify.Success($"Updated {_selected.Count} columns.");
        _selected.Clear();
        var cols = await Repository.GetColumnsAsync(filter: ColumnFilter.All);
        _all = cols.ToList();
    }

    private Task SetTypeD() => BulkSet("persistenceType", (object)'D');
    private Task SetTypeB() => BulkSet("persistenceType", (object)'B');

    private void ExportCsv()
    {
        // CSV export handled via a streaming endpoint; navigate to it with current filter state
        Nav.NavigateTo($"/api/catalogue/export?server={Uri.EscapeDataString(_filterServer)}" +
                       $"&database={Uri.EscapeDataString(_filterDatabase)}" +
                       $"&table={Uri.EscapeDataString(_filterTable)}" +
                       $"&column={Uri.EscapeDataString(_filterColumn)}" +
                       $"&persistence={_filterPersistence}");
    }
}
