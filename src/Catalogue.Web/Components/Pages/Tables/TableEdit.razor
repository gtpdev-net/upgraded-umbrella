@page "/servers/{SourceId:int}/databases/{DatabaseId:int}/tables/new"
@page "/servers/{SourceId:int}/databases/{DatabaseId:int}/tables/{TableId:int}/edit"
@rendermode InteractiveServer
@inject ICatalogueRepository Repository
@inject NavigationManager Nav
@inject NotificationService Notify

<PageTitle>@(_isNew ? "New Table" : "Edit Table") &mdash; Source Catalogue</PageTitle>

<BreadcrumbNav Items="@_breadcrumbs" />

<EditForm Model="_table" OnValidSubmit="Save" class="row g-3">
    <DataAnnotationsValidator />

    <div class="col-md-2">
        <label class="form-label">Schema</label>
        <InputText @bind-Value="_table.SchemaName" class="form-control" />
    </div>
    <div class="col-md-4">
        <label class="form-label">Table Name</label>
        <InputText @bind-Value="_table.TableName" class="form-control" />
        @if (_nameExists) { <div class="text-danger small">Already exists.</div> }
    </div>
    <div class="col-md-3">
        <label class="form-label">Est. Row Count</label>
        <InputNumber @bind-Value="_table.EstimatedRowCount" class="form-control" />
    </div>
    <div class="col-12">
        <label class="form-label">Notes</label>
        <InputTextArea @bind-Value="_table.Notes" class="form-control" rows="2" />
    </div>
    <div class="col-12">
        <div class="form-check">
            <InputCheckbox @bind-Value="_table.IsActive" class="form-check-input" id="isActive" />
            <label class="form-check-label" for="isActive">Active</label>
        </div>
    </div>

    <!-- Column sub-panel -->
    <div class="col-12">
        <h5 class="mt-2">Columns
            <span class="badge text-bg-secondary fs-6 ms-2">
                @_table.Columns.Count(c => c.IsActive) total &middot;
                @_table.Columns.Count(c => c.IsActive && (c.IsInDaoAnalysis || c.IsAddedByApi)) in scope &middot;
                @_table.Columns.Count(c => c.IsActive && c.IsSelectedForLoad) selected
            </span>
        </h5>

        <!-- Paste area -->
        <div class="input-group mb-2" style="max-width:500px">
            <textarea @bind="_pasteText" class="form-control" rows="2"
                      placeholder="Paste column names (one per line)..."></textarea>
            <button type="button" class="btn btn-outline-secondary" @onclick="PasteColumns">Add</button>
        </div>

        @if (_table.Columns.Any())
        {
            <table class="table table-sm table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:30px">#</th>
                        <th>Column Name</th>
                        <th style="width:100px">Type</th>
                        <th style="width:80px">DAO</th>
                        <th style="width:80px">API</th>
                        <th style="width:80px">For Load</th>
                        <th style="width:60px">Active</th>
                        <th style="width:60px"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var col in _table.Columns.OrderBy(c => c.SortOrder))
                    {
                        <tr>
                            <td>@col.SortOrder</td>
                            <td>@col.ColumnName</td>
                            <td>
                                <select class="form-select form-select-sm"
                                        value="@col.PersistenceType.ToString()"
                                        @onchange="e => col.PersistenceType = string.IsNullOrEmpty(e.Value?.ToString()) ? 'R' : e.Value!.ToString()![0]">
                                    <option value="R">R</option>
                                    <option value="D">D</option>
                                </select>
                            </td>
                            <td><input type="checkbox" @bind="col.IsInDaoAnalysis" /></td>
                            <td><input type="checkbox" @bind="col.IsAddedByApi" /></td>
                            <td><input type="checkbox" @bind="col.IsSelectedForLoad" /></td>
                            <td><input type="checkbox" @bind="col.IsActive" /></td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-danger"
                                        @onclick="() => RemoveColumn(col)">&times;</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- Add single column -->
        <div class="input-group mb-2" style="max-width:400px">
            <input class="form-control" placeholder="New column name..." @bind="_newColumnName" />
            <button type="button" class="btn btn-outline-primary" @onclick="AddColumn">Add Column</button>
        </div>
    </div>

    <div class="col-12 mt-2">
        <button type="submit" class="btn btn-primary me-2">Save</button>
        <a href="/servers/@SourceId/databases/@DatabaseId/tables" class="btn btn-secondary">Cancel</a>
    </div>

    @if (!_isNew)
    {
        <AuditFooter CreatedBy="@_table.CreatedBy" CreatedAt="_table.CreatedAt"
                     ModifiedBy="@_table.ModifiedBy" ModifiedAt="_table.ModifiedAt" />
    }
</EditForm>

@code {
    [Parameter] public int SourceId { get; set; }
    [Parameter] public int DatabaseId { get; set; }
    [Parameter] public int? TableId { get; set; }

    private SourceTable _table = new() { IsActive = true, SchemaName = "dbo" };
    private bool _nameExists;
    private bool _isNew => TableId == null;
    private string _pasteText = string.Empty;
    private string _newColumnName = string.Empty;
    private IEnumerable<BreadcrumbItem> _breadcrumbs = [];
    protected override async Task OnParametersSetAsync()
    {
        var db = await Repository.GetDatabaseByIdAsync(DatabaseId);
        var databaseName = db?.DatabaseName ?? DatabaseId.ToString();
        var serverName = db?.Source.ServerName ?? SourceId.ToString();

        _breadcrumbs =
        [
            new BreadcrumbItem("Servers", "/servers"),
            new BreadcrumbItem(serverName, $"/servers/{SourceId}/databases"),
            new BreadcrumbItem(databaseName, $"/servers/{SourceId}/databases/{DatabaseId}/tables"),
            new BreadcrumbItem(_isNew ? "New Table" : "Edit Table", isActive: true)
        ];

        if (TableId.HasValue)
        {
            var existing = await Repository.GetTableByIdAsync(TableId.Value);
            if (existing is not null) _table = existing;
        }
        else
        {
            _table.DatabaseId = DatabaseId;
        }
    }

    private void AddColumn()
    {
        if (string.IsNullOrWhiteSpace(_newColumnName)) return;
        var maxSort = _table.Columns.Any() ? _table.Columns.Max(c => c.SortOrder) : 0;
        _table.Columns.Add(new SourceColumn
        {
            ColumnName = _newColumnName.Trim(),
            PersistenceType = 'R',
            SortOrder = maxSort + 10
        });
        _newColumnName = string.Empty;
    }

    private void PasteColumns()
    {
        if (string.IsNullOrWhiteSpace(_pasteText)) return;
        var maxSort = _table.Columns.Any() ? _table.Columns.Max(c => c.SortOrder) : 0;
        var names = _pasteText.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        foreach (var name in names)
        {
            if (string.IsNullOrEmpty(name)) continue;
            maxSort += 10;
            _table.Columns.Add(new SourceColumn
            {
                ColumnName = name,
                PersistenceType = 'R',
                SortOrder = maxSort
            });
        }
        _pasteText = string.Empty;
    }

    private void RemoveColumn(SourceColumn col)
        => _table.Columns.Remove(col);

    private async Task Save()
    {
        _nameExists = await Repository.TableNameExistsAsync(
            DatabaseId, _table.SchemaName, _table.TableName,
            _isNew ? null : TableId);
        if (_nameExists) return;

        if (_isNew)
            await Repository.AddTableAsync(_table);
        else
            await Repository.UpdateTableAsync(_table);

        Notify.Success("Table saved.");
        Nav.NavigateTo($"/servers/{SourceId}/databases/{DatabaseId}/tables");
    }
}
