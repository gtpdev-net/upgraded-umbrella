@page "/import/excel"
@rendermode InteractiveServer
@inject ExcelImportService ExcelParser
@inject CatalogueImportService Importer
@inject NotificationService Notify

<PageTitle>Import Excel &mdash; Source Catalogue</PageTitle>

<h1>Import Excel</h1>

@if (_result is not null)
{
    <div class="alert alert-success">
        <strong>Import complete.</strong>
        Tables added: @_result.TablesAdded &middot;
        Columns added: @_result.ColumnsAdded &middot;
        Updated: @_result.ColumnsUpdated &middot;
        Skipped: @_result.ColumnsSkipped
        @foreach (var err in _result.Errors)
        {
            <div class="text-danger">@err</div>
        }
    </div>
}

<div class="row g-3" style="max-width:700px">
    <div class="col-12">
        <label class="form-label">Excel File (.xlsx)</label>
        <InputFile OnChange="LoadFile" accept=".xlsx" class="form-control" />
    </div>
    <div class="col-md-6">
        <label class="form-label">Conflict Strategy</label>
        <select class="form-select" @bind="_strategy">
            <option value="@ImportConflictStrategy.SkipExisting">Skip existing</option>
            <option value="@ImportConflictStrategy.AddNewOnly">Overwrite existing</option>
            <option value="@ImportConflictStrategy.FullSync">Merge intent flags only</option>
        </select>
    </div>
    <div class="col-md-6 d-flex align-items-end">
        <div class="form-check mb-2">
            <input type="checkbox" class="form-check-input" id="dryRun" @bind="_dryRun" />
            <label class="form-check-label" for="dryRun">Dry-run (preview only)</label>
        </div>
    </div>
    <div class="col-12">
        <button class="btn btn-primary" @onclick="RunPreview" disabled="@(_fileStream is null)">
            Preview
        </button>
    </div>
</div>

@if (_unrecognised is not null && _unrecognised.Count > 0)
{
    <div class="alert alert-warning mt-3">
        <strong>Unrecognised headers (will be ignored):</strong>
        @string.Join(", ", _unrecognised)
    </div>
}

@if (_preview is not null)
{
    <h4 class="mt-4">Preview (@_preview.Count rows)</h4>
    <div style="max-height:400px;overflow-y:auto;">
        <table class="table table-sm table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Server</th><th>Database</th><th>Schema</th>
                    <th>Table</th><th>Column</th><th>Type</th>
                    <th>DAO</th><th>API</th><th>Load</th><th>Warning</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in _preview.Take(200))
                {
                    <tr class="@(string.IsNullOrEmpty(r.Warning) ? "" : "table-warning")">
                        <td>@r.ServerName</td><td>@r.DatabaseName</td><td>@r.SchemaName</td>
                        <td>@r.TableName</td><td>@r.ColumnName</td><td>@r.PersistenceType</td>
                        <td><FlagBadge Value="@r.IsInDaoAnalysis" /></td>
                        <td><FlagBadge Value="@r.IsAddedByApi" /></td>
                        <td><FlagBadge Value="@r.IsSelectedForLoad" /></td>
                        <td>@r.Warning</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    @if (!_dryRun)
    {
        <button class="btn btn-success mt-2" @onclick="Commit">Import @_preview.Count rows</button>
    }
}

<ConfirmDialog @ref="_confirmDialog" Title="Confirm Import" ConfirmText="Import" />

@code {
    private ImportConflictStrategy _strategy = ImportConflictStrategy.SkipExisting;
    private bool _dryRun = true;
    private MemoryStream? _fileStream;
    private IReadOnlyList<ImportPreviewRow>? _preview;
    private IReadOnlyList<string>? _unrecognised;
    private ImportResultDto? _result;
    private ConfirmDialog _confirmDialog = null!;

    private async Task LoadFile(InputFileChangeEventArgs e)
    {
        _fileStream = new MemoryStream();
        await e.File.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024).CopyToAsync(_fileStream);
        _fileStream.Position = 0;
    }

    private void RunPreview()
    {
        if (_fileStream is null) return;
        _fileStream.Position = 0;
        try
        {
            var (rows, unrecognised) = ExcelParser.Parse(_fileStream);
            _preview = rows;
            _unrecognised = unrecognised;
        }
        catch (Exception ex)
        {
            Notify.Error($"Failed to parse Excel: {ex.Message}");
        }
    }

    private async Task Commit()
    {
        if (_preview is null) return;
        var ok = await _confirmDialog.ShowAsync($"Import {_preview.Count} rows?");
        if (!ok) return;
        _result = await Importer.ImportAsync(_preview, _strategy, dryRun: false);
        Notify.Success("Import complete.");
        _preview = null;
    }
}
